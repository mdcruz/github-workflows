name: Manual Prod Deploy (Environment-gated)

on:
  workflow_dispatch:
    inputs:
      dev_tag:
        description: 'The dev deployment tag created by the dev workflow (e.g. dev-deployed-abc123). Leave blank to pick the latest dev-deployed tag.'
        required: false
      confirm:
        description: 'type YES to confirm you want to run this prod deploy'
        required: true
        default: 'NO'

permissions:
  contents: read
  id-token: write

jobs:
  resolve-dev-tag:
    name: Resolve dev tag
    runs-on: ubuntu-latest
    outputs:
      resolved_dev_tag: ${{ steps.resolve.outputs.resolved_tag }}
    steps:
      - name: Checkout (fetch tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve dev tag (use input or pick latest dev-deployed tag)
        id: resolve
        run: |
          set -e
          if [ -n "${{ github.event.inputs.dev_tag }}" ]; then
            echo "Using provided dev_tag: ${{ github.event.inputs.dev_tag }}"
            tag="${{ github.event.inputs.dev_tag }}"
          else
            # find latest tag matching dev-deployed-*
            git fetch --tags origin
            tag=$(git tag --list "dev-deployed-*" --sort=-creatordate | head -n1)
            if [ -z "$tag" ]; then
              echo "No dev-deployed-* tag found. Exiting."
              exit 2
            fi
            echo "Resolved latest dev tag: $tag"
          fi
          # verify tag exists on origin
          if git ls-remote --tags origin "refs/tags/$tag" | grep -q "$tag"; then
            echo "Tag exists: $tag"
          else
            echo "Tag $tag not found on origin. Exiting."
            exit 3
          fi
          echo "::set-output name=resolved_tag::$tag"

      - name: Confirm intent
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "YES" ]; then
            echo "User did not confirm with YES. Aborting."
            exit 4
          fi

  deploy-prod:
    name: Deploy to Production (environment gated)
    runs-on: ubuntu-latest
    needs: resolve-dev-tag
    environment: production             # <-- GitHub will require environment approval(s) configured in repo settings
    steps:
      - name: Checkout (refs including tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and checkout dev tag
        run: |
          tag="${{ needs.resolve-dev-tag.outputs.resolved_dev_tag }}"
          echo "Checking out code from tag: $tag"
          git fetch --tags origin
          git checkout "tags/$tag" -b "deploy-from-$tag"

      - name: Prod deploy (placeholder)
        run: |
          echo "Deploying to production using code at tag ${{ needs.resolve-dev-tag.outputs.resolved_dev_tag }}"
          # Put your prod deploy commands here, e.g.
          # ./scripts/deploy-prod.sh --tag "${{ needs.resolve-dev-tag.outputs.resolved_dev_tag }}"
